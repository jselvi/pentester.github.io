---
layout: post
title: Fedora / Ubuntu Time Synchronization
date: '2015-10-28T08:00:00.000+01:00'
author: Jose Selvi
tags:
- Linux
- NTP
- Tools
- MitM
- Delorean
modified_time: '2015-10-28T08:00:07.252+01:00'
thumbnail: https://i.ytimg.com/vi/MxAJDc7g9SQ/default.jpg
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-1519994594470529945
blogger_orig_url: http://www.en.pentester.es/2015/10/ntp-linux.html
---

<div style="text-align: justify;">Have a look to other posts of this serie:<br /><br /><div style="text-align: justify;"><a href="https://www.pentester.es/delorean/" target="_blank">[1] NTP MitM Attack using a Delorean</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-macosx/" target="_blank">[2] Mac OS X Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-linux/" target="_blank">[3] Fedora / Ubuntu Time Synchronization</a></div><div style="text-align: justify;">[4] Microsoft Time Synchronization</div><div style="text-align: justify;">[5] Attacking HTTP Strict Transport Security</div><div style="text-align: justify;">[6] Attacking the Public Key Infrastructure</div>[7] Other Attacks<br />[8] Helper tools<br /><br />Yesterday we were talking about how time synchronization works in Mac OS X, and how it is different for pre-Mavericks versions and the most modern ones. Today, we are having a look to GNU/Linux. Of course, we have a big amount of Linux flavors available, and we couldn't review all of them, but I chose the two favors that I think are most extended in desktop users (Ubuntu and Fedora), since they would be the target for this attacks.<br /><br />Disclaimer: All this information has been obtained from empirical tests and in a specific period of time, so they could have changed.<br /><br /><b>Ubuntu Linux</b> is the only one reviewed system that doesn't synchronize the time in a regular basis, so it isn't just a matter of waiting the necessary amount of time and intercept the NTP request. In Ubuntu, time synchronization is done each time than a network interface comes up (and, of course, when the system boots up). This is easy to see if we have a look at the script files that Ubuntu runs when that happens:<br /><br />$ ls /etc/network/if-up.d/<br />000resolvconf&nbsp; avahi-daemon&nbsp; <b>ntpdate</b>&nbsp; wpasupplicant<br />avahi-autoipd&nbsp;&nbsp; ethtool&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; upstart<br /><br />There isn't any restriction in terms of a big date change, so we could easily intercept this request and set the computer's clock using Delorean. There are two possible scenarios: Intercept at boot time or when the computer connects to a network, or just detach the computer from the network (deauth on a Wifi, for example) and wait for the next connection.<br /><br />On the other hand, <b>Fedora Linux</b> use a similar approach than Mac OS X. In previous versions, it just synchronized the time each minute, without any security restrictions, so it was easy and fast to use Delorean in order to tamper the system clock:<br /><br />$ tcpdump -i eth0 -nn src port 123<br />12:<b>43</b>:50.614191 IP 192.168.1.101.123 &gt; 89.248.106.98.123: NTPv3, Client, length 48<br />12:<b>44</b>:55.696390 IP 192.168.1.101.123 &gt; 213.194.159.3.123: NTPv3, Client, length 48<br />12:<b>45</b>:59.034059 IP 192.168.1.101.123 &gt; 89.248.106.98.123: NTPv3, Client, length 48<br /><br />At some point they changed the synchronization approach. At this moment, there is a daemon called "chrony" which works in a similar way than "pacemaker" in Mac OS X. However, Chrony are configured in a more secure way than Pacemaker. By default, it doesn't accept big date changes. It only accepts them in the first three tries from the last reboot, so we can still use a Delorean attack at boot time or if we can crash the chrony service.<br /><br />We're probably going too fast, because we haven't talked about HSTS and how it could be bypassed using time synchronization attacks, but let me show you an example of this attack against an Ubuntu Linux box:<br /><div style="text-align: center;"><br /></div><div style="text-align: center;"><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/MxAJDc7g9SQ" width="560"></iframe></div></div>