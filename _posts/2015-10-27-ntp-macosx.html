---
layout: post
title: Mac OS X Time Synchronization
date: '2015-10-27T08:00:00.000+01:00'
author: Jose Selvi
tags:
- NTP
- Tools
- MitM
- MacOSX
- Delorean
modified_time: '2015-10-28T07:58:23.349+01:00'
thumbnail: http://1.bp.blogspot.com/-ZzYptvH-Ubs/Vi6UCWoqwqI/AAAAAAAACAk/TaRX2LUc_-E/s72-c/boot.png
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-8708610049388463402
blogger_orig_url: http://www.en.pentester.es/2015/10/ntp-macosx.html
---

<div style="text-align: justify;">Have a look to other posts of this serie:<br /><br /><div style="text-align: justify;"><a href="https://www.pentester.es/delorean/" target="_blank">[1] NTP MitM Attack using a Delorean</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-macosx/" target="_blank">[2] Mac OS X Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-linux/" target="_blank">[3] Fedora / Ubuntu Time Synchronization</a></div><div style="text-align: justify;">[4] Microsoft Time Synchronization</div><div style="text-align: justify;">[5] Attacking HTTP Strict Transport Security</div><div style="text-align: justify;">[6] Attacking the Public Key Infrastructure</div>[7] Other Attacks<br />[8] Helper tools<br /><br />Last week we showed how Delorean works, and how we could use it in order to tamper NTP responses. However, time synchronization work slightly different between OS vendors.<br /><br />Disclaimer: All this information has been obtained from empirical tests and in a specific period of time, so they could have changed.<br /><br />Pre-Mavericks Mac OS X use a simple time synchronization approach. An ntpd daemon is running and time is synchronized each 9 minutes. Any restriction or security configuration are applied in this daemon, so an attacker could use Delorean and change the internal clock easily.<br /><br /><i>$ tcpdump -i eth0 -nn src port 123<br />09:<b>02</b>:18.166708 IP 192.168.1.100.123 &gt; 17.72.148.53.123: NTPv4, Client, length 48<br />09:<b>11</b>:20.059792 IP 192.168.1.100.123 &gt; 17.72.148.53.123: NTPv4, Client, length 48<br />09:<b>20</b>:17.951361 IP 192.168.1.100.123 &gt; 17.72.148.53.123: NTPv4, Client, length 48 </i><br /><br />However, Apple changed the time synchronization in Mavericks. NTPd is still running but it doesn't change the clock directly. The time drift is stored in /var/db/ntp.drift , and there is another service, called "pacemaker" that should check this file and change the clock if needed.<br />This new service has several benefits. For example, It adapts the amount of NTP requests to the powers state (plugged or battery). Another important difference is that clock changes are not applied in a single step. The clock speeds up or slows down in order to correct the date but avoiding big time steps. It doesn't implement any other security feature so it can be intercepted using Delorean as well.<br /><br />Despite it shouldn't be a problem, we have found that NTPd wasn't working properly in modern versions of Mac OS X, so time synchronization was not working at all. <a href="http://www.atmythoughts.com/living-in-a-tech-family-blog/2014/2/28/what-time-is-it" target="_blank">There are some people arguing in the Internet about this</a>. Does it mean that modern Mac OS X are not vulnerable to a Delorean attack? The answer is NO. Let's have a look to the <i>/usr/libexec/ntpd-wrapper</i> script:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-ZzYptvH-Ubs/Vi6UCWoqwqI/AAAAAAAACAk/TaRX2LUc_-E/s1600/boot.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="260" src="http://1.bp.blogspot.com/-ZzYptvH-Ubs/Vi6UCWoqwqI/AAAAAAAACAk/TaRX2LUc_-E/s400/boot.png" width="400" /></a></div><br />As you can see above, Mac OS X runs a sntp (simple NTP) command at boot, before running the NTPd daemon. This sntp binary is not affected by the same bug, so <b>we could intercept this synchronization and run a Delorean attack when a Mac OS X boots up</b>.<br /><br />There is still an additional way to exploit this weak time synchronization in Mac OS X. When a user opens the "<i>Date &amp; Time Preferences</i>" menu, the operating system automatically synchronize the time without user's knowledge, so we could use Delorean in this scenario as well.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-3s3LhvVLSjs/Vi6VtPNySFI/AAAAAAAACAw/mx7BiQ2sOI4/s1600/menuwin.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="233" src="http://1.bp.blogspot.com/-3s3LhvVLSjs/Vi6VtPNySFI/AAAAAAAACAw/mx7BiQ2sOI4/s400/menuwin.png" width="400" /></a></div><br />In the following posts, we will see how we could exploit this in order to intercept SSL communications, as we presented in DEF CON recently.</div>