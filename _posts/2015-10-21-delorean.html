---
layout: post
title: NTP MitM Attack using a Delorean
date: '2015-10-21T08:00:00.000+02:00'
author: Jose Selvi
tags:
- NTP
- Tools
- MitM
- Delorean
modified_time: '2015-10-28T07:58:07.137+01:00'
thumbnail: http://4.bp.blogspot.com/-I_M_01BRJY0/ViW1HcNUHvI/AAAAAAAAB_0/6ALFEFArSl4/s72-c/back-to-the-future-2015.jpg
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-6013359260314493791
blogger_orig_url: http://www.en.pentester.es/2015/10/delorean.html
---

<div style="text-align: justify;">Around one and a half year ago, I started a research about how computers synchronize their internal clocks, and how this could be used in order to attack well-known protocols and services running in Operating Systems. As a result, I have presented my findings in several security conferences such as <a href="https://www.blackhat.com/eu-14/briefings.html#bypassing-http-strict-transport-security" target="_blank">BlackHat Europe 2014</a>, <a href="http://www.rootedcon.es/" target="_blank">RootedCON 2015</a> (Spanish), <a href="https://www.defcon.org/html/defcon-23/dc-23-speakers.html#Selvi" target="_blank">DEF CON 23</a> and <a href="http://navajanegra.com/" target="_blank">Navaja Negra / ConectaCON 2015</a> (Spanish).</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-I_M_01BRJY0/ViW1HcNUHvI/AAAAAAAAB_0/6ALFEFArSl4/s1600/back-to-the-future-2015.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="180" src="http://4.bp.blogspot.com/-I_M_01BRJY0/ViW1HcNUHvI/AAAAAAAAB_0/6ALFEFArSl4/s320/back-to-the-future-2015.jpg" width="320" /></a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Today, October 21th 2015, it's the date when Marty McFly went to the future in the second part of the amazing Back to the Future saga, so I can't think in a better date to start releasing all the details about this research.</div><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="text-align: justify;"><a href="https://www.pentester.es/delorean/" target="_blank">[1] NTP MitM Attack using a Delorean</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-macosx/" target="_blank">[2] Mac OS X Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-linux/" target="_blank">[3] Fedora / Ubuntu Time Synchronization</a></div><div style="text-align: justify;">[4] Microsoft Time Synchronization</div><div style="text-align: justify;">[5] Attacking HTTP Strict Transport Security</div><div style="text-align: justify;">[6] Attacking the Public Key Infrastructure</div>[7] Other Attacks<br />[8] Helper tools<br /><br /><div style="text-align: justify;">As we will see in the upcoming posts, all the OS vendors that I have tested use the Network Time Protocol (NTP) in order to keep their internal clock accurate, which is very important for some authentication protocols and other stuff. Most of them don't deploy this service in a secure way, making it vulnerable to Man-in-the-Middle attacks.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">In order to exploit this issue, I developed a tool called <b><u><a href="https://github.com/PentesterES/Delorean" target="_blank">DELOREAN</a></u></b>. Delorean is an NTP server written in python, open source and&nbsp;<a href="https://github.com/PentesterES/Delorean" target="_blank">available from GitHub</a> (contributions are welcomed). I borrowed a few lines of code from <a href="http://github.com/limifly/ntpserver" target="_blank">kimifly's ntpserver</a> and, of course, all the credits to him have been included.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">What makes Delorean different and useful for us is that we can configure its flags in order to make it work in a different way than a regular NTP server. Basically, we can configure it in order to send fake&nbsp;responses, similar to the Metasploit's fakedns module.</div><br /><i>$ ./delorean.py -h<br />Usage: delorean.py [options]<br /><br />Options:<br />  -h, --help            show this help message and exit<br />  -i INTERFACE, --interface=INTERFACE&nbsp;Listening interface<br />  -p PORT, --port=PORT  Listening port<br />  -n, --nobanner        Not show Delorean banner<br />  -s STEP, --force-step=STEP&nbsp;Force the time step: 3m (minutes), 4d (days), 1M&nbsp;(month)<br />  -d DATE, --force-date=DATE&nbsp;Force the date: YYYY-MM-DD hh:mm[:ss]<br />-x, --random-date     Use random date each time</i><br /><br /><div style="text-align: justify;">We have the typical interface (-i) and port (-p) flags, that help us to bind the service exactly where we want. The -n flag only hides the super-cool Delorean banner :)</div><div style="text-align: justify;"><br /></div><div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;_._ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _.-="_- &nbsp; &nbsp; &nbsp; &nbsp; _&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _.-=" &nbsp; _-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | ||"""""""---._______ &nbsp; &nbsp; __.. &nbsp; &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ___.===""""-.______-,,,,,,,,,,,,`-''----" """"" &nbsp; &nbsp; &nbsp; """""&nbsp; __'&nbsp; &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp;&nbsp; &nbsp; &nbsp; __.--"" &nbsp; &nbsp; __&nbsp; &nbsp; &nbsp; &nbsp; ,' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o \ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __&nbsp; &nbsp; &nbsp; &nbsp; [__|&nbsp; &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp; __-""=======.--""&nbsp; ""--.=================================.--""&nbsp; ""--.=======: &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp;] &nbsp; &nbsp; &nbsp; [w] : /&nbsp; &nbsp; &nbsp; &nbsp; \ : |========================|&nbsp; &nbsp; : /&nbsp; &nbsp; &nbsp; &nbsp; \ :&nbsp; [w] : &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp;V___________:|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |: |========================|&nbsp; &nbsp; :|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |: &nbsp; _-"&nbsp; &nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp; V__________: \&nbsp; &nbsp; &nbsp; &nbsp; / :_|=======================/_____: \&nbsp; &nbsp; &nbsp; &nbsp; / :__-" &nbsp; &nbsp;&nbsp;</div><div style="font-family: Menlo; font-size: 12px; line-height: normal;">&nbsp; -----------'&nbsp; ""____""&nbsp; `-------------------------------'&nbsp; ""____"" &nbsp;</div><br /><div style="text-align: justify;">We can use Delorean in several modes, but we are going to focus in the most useful ones. There are some other attacks that weren't really interesting after developing them, but they are still in the code. Perhaps I will remove them in the future, sine they require scapy and some dependencies.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Since it's too soon yet to talk about how OS synchronize, we will test how Delorean works using the command line tool "ntpdate":</div><br /><i>$ ntpdate -q 192.168.1.2<br />server 192.168.1.2, stratum 2, <b>offset 97372804.086845</b>, delay 0.02699<br />20 Oct 06:05:45 ntpdate[881]: step time server 192.168.1.2 offset <b>97372804.086845 sec</b></i><br /><br />By default (no flags), Delorean responses a date that matches the same week and month day than the current date, but at least 1000 days in the future. This was useful for the HSTS bypass as we will see in upcoming posts.</div><br /><i># ./delorean.py -n <br />[19:44:42] Sent to 192.168.10.113:123 - Going to the future! 2018-08-31 19:44 <br />[19:45:18] Sent to 192.168.10.113:123 - Going to the future! 2018-08-31 19:45</i><br /><div><br /></div><div>We can set a relative jump from the current date using the step flag (-s). Relative jumps can be defined as 10d (ten days in the future), -2y (two years in the past), etc:</div><br /><i># ./delorean.py -s 10d -n <br />[19:46:09] Sent to 192.168.10.113:123 - Going to the future! 2015-08-10 19:46 <br />[19:47:19] Sent to 192.168.10.113:123 - Going to the future! 2015-08-10 19:47</i><br /><br />We can also set a specific date, and Delorean would answer always the same date:<br /><br /><i># ./delorean.py -d ‘2020-08-01 21:15’ -n <br />[19:49:50] Sent to 127.0.0.1:48473 - Going to the future! 2020-08-01 21:15 <br />[19:50:10] Sent to 127.0.0.1:52406 - Going to the future! 2020-08-01 21:15</i><br /><br /><div style="text-align: justify;">There are an additional attack called "Skimming Attack" that is useful only on certain configurations, but we will go in depth with it when we will talk about Microsoft synchronization, despite it could be useful in other platforms.</div>