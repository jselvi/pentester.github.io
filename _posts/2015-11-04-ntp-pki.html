---
layout: post
title: Attacking the Public Key Infrastructure
date: '2015-11-04T10:30:00.000+01:00'
author: Jose Selvi
tags:
- DEFCON
- NTP
- Tools
- MitM
- Delorean
modified_time: '2016-01-24T09:30:10.353+01:00'
thumbnail: http://2.bp.blogspot.com/-BQVFp9n6myQ/VjmbzVfeRmI/AAAAAAAACEY/0ozEqBXQ2QU/s72-c/certchain.png
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-3392138443233511784
blogger_orig_url: http://www.en.pentester.es/2015/11/ntp-pki.html
---

<div style="text-align: justify;">Have a look to other posts of this serie:<br /><br /><div style="text-align: justify;"><a href="https://www.pentester.es/delorean/" target="_blank">[1] NTP MitM Attack using a Delorean</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-macosx/" target="_blank">[2] Mac OS X Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-linux/" target="_blank">[3] Fedora / Ubuntu Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-microsoft/" target="_blank">[4] Microsoft Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-hsts/" target="_blank">[5] Attacking HTTP Strict Transport Security</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-pki/" target="_blank">[6] Attacking the Public Key Infrastructure</a></div><a href="https://www.pentester.es/ntp-other-attacks/" target="_blank">[7] Other Attacks</a><br />[8] Helper tools<br /><br />Disclaimer: All this information has been obtained from  empirical tests and in a specific period of time, so they could have  changed.</div><div style="text-align: justify;"><br />Disclaimer (2): In this post I talk about certificates, SSL keys, etc. Please note that I could talk about (for example) "the certificates's private key" because it's the way I usually speak, but probably it isn't the most correct term. I should talk about "the private key of the certificate's public key", but I think it's easier to understand if we simplify this. Any way, if something sounds confusing, just drop me an email or comment and I'll try to clarify it.<br /><br />From the number of attacks that I tried using Deloran, this was my favorite one. While I was thinking about what could go wrong when the clock can be tampered, SSL certificates expiration dates came to my mind.<br /><br />As you probably know, a SSL certificate is valid if:<br /><ul><li>It was issued by a trusted certification authority (CA) or by an Intermediate CA that was issued by a trusted CA.</li><li>Common name matches the server's hostname (wildcards can be used).</li><li><b>Current date is between the "Not valid before" and "Not valid after" dates.</b></li></ul>When a SSL certificate expire, we need to get a new one, and the older ones are usually forgotten, because they're invalid (3rd case). However, with Delorean this isn't completely true, since we could tamper the internal clock and make a computer to believe that an old certificate is valid.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-BQVFp9n6myQ/VjmbzVfeRmI/AAAAAAAACEY/0ozEqBXQ2QU/s1600/certchain.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="227" src="http://2.bp.blogspot.com/-BQVFp9n6myQ/VjmbzVfeRmI/AAAAAAAACEY/0ozEqBXQ2QU/s400/certchain.png" width="400" /></a></div><br />But we can't attack all the old certificates in the world using Delorean. We need to find certificates with the following conditions:<br /><ul><li><u>We need to reconstruct the old certificate chain</u>: This isn't a problem, since CA certificates have long validity periods, so perhaps the current certificate chain also works with the old certificate, and if not, looking for the "Issuer name" in the Internet usually works.</li><li><u>Root CA</u> (starts the certificate chain) <u>has to be a trusted OS/Browser CA</u>: If the root CA has expired and remove from the browser's certificates database, victim's browser won't be able to validate the certificate chain. This is only a problem for root CAs. Any other Intermediate CA could be expired and that wouldn't avoid our attack.</li><li><u>We need to find the old host certificate</u>: This is harder than it seems. It's not such an easy task. Let's talk about this a few lines below.</li><li><u>We need to be able to get the host certificate's private key</u>: This is the only one private key that we need to know. That's why we're interested in old certificates, because we could find much easier ways to get the private key than in modern ones. Let's talk about this a few lines below as well.</li></ul>So... we said that we need to get old SSL host certificates. Where could I find them? Unfortunately, I did't grab SSL certificates 10 years ago, so I need to find somebody else in the Internet that did it. I spent a lot of time looking for this kind of database (the oldest the better, of course) and the better and oldest resource that I found was <a href="https://www.eff.org/observatory" target="_blank">The SSL Observatory</a> from <a href="https://www.eff.org/" target="_blank">EFF</a>. They crawled the Internet in 2010 and stored a huge database with all the SSL certificates that they found.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-iXfApA2dVWU/VjmjX84j_LI/AAAAAAAACEo/9JJJQ0gkDXA/s1600/observatory.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://1.bp.blogspot.com/-iXfApA2dVWU/VjmjX84j_LI/AAAAAAAACEo/9JJJQ0gkDXA/s400/observatory.png" width="342" /></a></div><br />Now that we have an old SSL certificates database, we can start looking for certificates that we think we could break and get it's private key. For example, something that came to my mind was the <a href="https://freakattack.com/" target="_blank">FREAK attack</a>. As a part of this attack, they cracked RSA-512 keys in a few hours, using a big Amazon EC2 cluster, so we could do something similar if we find RSA-512 certificates in our database.<br /><br />Unfortunately, the most interesting targets (Google, Facebook, etc) didn't use RSA-512 in 2010. Maybe if we had an older database... Anyway, I was able to found some interesting certificates and some funny ones, such as a Disney site (not the main site).<br /><br /><u>Disclaimer</u> (3): When I do a Delorean demo using a website, I'm <u><b>NOT</b></u> attacking the website. The website is <u><b>NOT</b></u> vulnerable. I'm attacking a vulnerable client, that is my own testing machine, so I'm attacking myself, not the website.<br /><br />I'm not going to specify step by step how I crack the RSA-512 certificate, because I would be a post (or some of them) itself, and because It was the fist time that I did it, so you can find much more useful information in the Internet <a href="https://github.com/tomrittervg/cloud-and-control/blob/master/gnfs-info/factoring-howto.txt" target="_blank">[1]</a><a href="https://www.cis.upenn.edu/~nadiah/projects/faas/" target="_blank">[2]</a><a href="http://cado-nfs.gforge.inria.fr/" target="_blank">[3]</a><a href="http://gilchrist.ca/jeff/factoring/nfs_beginners_guide.html" target="_blank">[4]</a>. At the end of the day, I had four EC2 machines running 3 days (as far as I remember) and It was around $150 in total.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-PsrxcEqpAGY/Vjm6jqhKTbI/AAAAAAAACFg/AY1GnxlujkY/s1600/cracked.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="208" src="http://2.bp.blogspot.com/-PsrxcEqpAGY/Vjm6jqhKTbI/AAAAAAAACFg/AY1GnxlujkY/s400/cracked.png" width="400" /></a></div><br />Once you have factored the old RSA key, you have the two prime numbers that were used to create the public and private keys, so you just need to do it again (<a href="http://www.loyalty.org/~schoen/rsa/private-from-pq.c" target="_blank">private-from-pq.c</a>) to get the private key. Let's see if it works or not.<br /><br /><center><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/GOYlAs2w7S4" width="420"></iframe></center><br />It works! The certificate chain is valid again and we have the private key, so we can cheat the browser and impersonate the website. Cool!<br /><br />As far as I have read (I'm not an expert in this field), Governments and other organizations with enough resources could crack RSA-1024 in a reasonable time. This is even more interesting than my demo, because RSA-512 is now banned from most modern browsers, so they would reject the certificate chain. I did this demo using an RSA-512 certificate because I don't have at this moment enough resources to crack RSA-1024 and because It's exactly the same process, so if we can do this for RSA-512 in a slightly old browser, we definitely could do it for RSA-1024 if we had enough cracking power.<br /><br />This is not the only one old weakness that we can use:<br /><ul><li><a href="http://pastebin.com/ff7Yg663" target="_blank">Hacked keys </a></li><li><a href="http://heartbleed.com/" target="_blank">Heartbleeded</a> keys</li><li>Weak certificate signatures (see "<a href="http://www.win.tue.nl/hashclash/rogue-ca/" target="_blank">MD5 considered harmful today</a>")</li><li><a href="https://github.com/g0tmi1k/debian-ssh" target="_blank">Debian PRNG generated keys</a></li><li>Many more...</li></ul>But there's something that probably came to your mind. What about certificate revocation? This isn't a problem with cracked certificates, because they never were revoked, but hacked certificates, heartbleeded, debian prng, etc ... all those certificates should have been revoked after generating a new one.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-1r_DH-mJsXc/VjmtYZP2xII/AAAAAAAACFE/c8oJnYwbejM/s1600/revokation.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="242" src="http://1.bp.blogspot.com/-1r_DH-mJsXc/VjmtYZP2xII/AAAAAAAACFE/c8oJnYwbejM/s400/revokation.png" width="400" /></a></div><br />A Certificate Revocation List (CRL) is the database where all the revoked certificates are stored. Browsers download them (or request information via online services) and check if a given certificate is revoked or not, If it is, they reject the communication even if all the certificate chain is valid.<br /><br />When I was facing this problem, the question that came to my mind was: Do those CRLs store ALL the revoked certificates? From the beginning of time? This would make this files HUGE, which is something that could affect performance. Well, I can't be 100% sure about this, but I did some quick tests to check if CAs purge their CRLs when revoked certificates are not valid because of their validity period.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-J-EZ_zsO-8Y/VjmvSi7fZ3I/AAAAAAAACFQ/iyhIG3-dvkM/s1600/cas.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="218" src="http://1.bp.blogspot.com/-J-EZ_zsO-8Y/VjmvSi7fZ3I/AAAAAAAACFQ/iyhIG3-dvkM/s400/cas.png" width="400" /></a></div><br />I focused only in one simple test. I opened several well-known websites in my browser and I got their issuer certificate. Then I downloaded the referenced CRL and I looked for big difference between the date when the certificate was issued and the date of the oldest revoked certificate. If the certificate was issued in 2008,&nbsp; and the first certificate in the CRL was revoked in 2012, and the second one in 2014... that's pretty weird. My humble opinion is that those CAs are purging expired certificates because they will be invalid anyway. That's 100% true, but it lets us to use our attack against those certificates, even if they should be revoked.<br /><br />Online Certificate Status Protocol (OCSP) doesn't really help (it's even easier), because most browsers are configured in order to accept certificates if they can't validate them, so an attacker just needs to drop OCSP connections. More information <a href="https://www.grc.com/revocation/implementations.htm" target="_blank">HERE</a>.<br /><br />From the list above, I looked for certificates that were generated using the old Debian PRNG bug. The problem was that this happened in 2008 and the SSL database that we have is from 2010, so most interesting websites changed their certificates before 2010. <br /><br />Looking around the Internet I found <a href="http://codefromthe70s.org/sslblacklist.aspx" target="_blank">CodeFromThe70s</a>. They developed a Firefox extension that detected certificated generated by the Debian PRNG bug. Detections were sent to them so they have a nice blacklist in their website. I used that list to find a certificate that I could use to test if it's still revoked or not.<br /><br />Next step was to get the private key. This wasn't as fast as I thought, because the pre-generated list published by HD Moore was for SSH keys only, so I needed to generate my own for HTTPS. What I did was to use the original patched "getpid.so" library and "ubunturoot" chrooted environment (original link was broken, so <a href="https://github.com/g0tmi1k/debian-ssh" target="_blank">I downloaded it from here</a>), and I developed a couple of shell scripts that just generate all possible SSL key pairs and check if it's the one I'm looking for:<br /><i><br /></i><i>$ <b>cat keyfind.sh </b><br />#!/bin/bash</i><br /><i>TARGET=0123456789abcdef0123456789abcdef<br /><br />for PID in `seq 1 32768`<br />do<br />&nbsp;&nbsp;&nbsp; chroot . /generate.sh $PID &amp;&gt;/dev/null</i><br /><i>&nbsp;&nbsp;&nbsp; openssl rsa -in private.pem -noout -modulus | openssl md5 | awk '{print $2}' | grep "$TARGET"<br />&nbsp;&nbsp;&nbsp; if [ $? -eq 0 ]<br />&nbsp;&nbsp;&nbsp; then<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; cp private.pem found.pem<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; echo "FOUND!"<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; exit<br />&nbsp;&nbsp;&nbsp; fi<br />&nbsp;&nbsp;&nbsp; rm -f private.pem<br />&nbsp;&nbsp;&nbsp; echo $PID&nbsp;&nbsp;&nbsp; <br />done</i><br /><i><br /></i><i>$ <b>generate.sh</b> <br />#!/bin/bash<br /><br />export MAGICPID=$1<br />export LD_PRELOAD=/getpid.so<br />/usr/bin/openssl genrsa -out private.pem 1024 &amp;&gt;/dev/null</i><br /><br />It took a few hours but I was able to get this private key as well. Maybe it wasn't the most efficient way, but it worked for me. The resulting demo is following:<br /><br /><center><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/QgLy6J_yNAQ" width="420"></iframe></center><br />My DEF CON talk (August 7th, 2015) is online, so you can have a look as well. I presented this as well in Spanish in RootedCON (March 2015) and NavajaNegra/ConectaCON (October 2015), but their haven't published the videos yet:<br /><br /><center></center><center></center><center><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/hkw9tFnJk8k" width="560"></iframe></center></div>