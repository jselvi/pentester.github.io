---
layout: post
title: Attacking HTTP Strict Transport Security
date: '2015-11-02T16:00:00.000+01:00'
author: Jose Selvi
tags:
- NTP
- Tools
- MitM
- BlackHat
- Delorean
modified_time: '2015-11-02T16:00:00.742+01:00'
thumbnail: http://1.bp.blogspot.com/-ItFtbNn2ER8/VjWoevidU6I/AAAAAAAACDA/kEDIgpxoCmc/s72-c/hsts.png
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-2340178942592266505
blogger_orig_url: http://www.en.pentester.es/2015/11/ntp-hsts.html
---

<div style="text-align: justify;">Have a look to other posts of this serie:<br /><br /><div style="text-align: justify;"><a href="https://www.pentester.es/delorean/" target="_blank">[1] NTP MitM Attack using a Delorean</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-macosx/" target="_blank">[2] Mac OS X Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-linux/" target="_blank">[3] Fedora / Ubuntu Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-microsoft/" target="_blank">[4] Microsoft Time Synchronization</a></div><div style="text-align: justify;"><a href="https://www.pentester.es/ntp-hsts/" target="_blank">[5] Attacking HTTP Strict Transport Security</a></div><div style="text-align: justify;">[6] Attacking the Public Key Infrastructure</div>[7] Other Attacks<br />[8] Helper tools<br /><br />Disclaimer: All this information has been obtained from  empirical tests and in a specific period of time, so they could have  changed.</div><div style="text-align: justify;"><br />In the last few posts we have reviewed how time synchronization works in different operating systems and how we could change the clock using Delorean in each of them. However, we haven't seen any practical attack. What can we do by tampering a computer's clock?<br /><br />I started this research because I was doing a MitM demo, using <a href="http://www.thoughtcrime.org/software/sslstrip/" target="_blank">SSLStrip</a>, and it didn't work when I tried to visit GMail and other well-known websites. That was weird, because I had done the same demo many times in the past. Debugging the problem I discovered an HTTP header called "<a href="https://www.owasp.org/index.php/HTTP_Strict_Transport_Security" target="_blank">Strict-Transport-Security</a>", something that had never seen before.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-ItFtbNn2ER8/VjWoevidU6I/AAAAAAAACDA/kEDIgpxoCmc/s1600/hsts.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="236" src="http://1.bp.blogspot.com/-ItFtbNn2ER8/VjWoevidU6I/AAAAAAAACDA/kEDIgpxoCmc/s400/hsts.png" width="400" /></a></div><br />HTTP Strict Transport Security (aka HSTS) is a security protection that was released in 2012 and, despite is not widely used in the Internet yet, most well-known providers use it at this moment. The server part is really simple, a webserver just needs to set up the "Strict-Transport-Security" header setting the desired policy using the "max-age" and "includeSubdomains" parameters. In the example above, the web server sets a policy in the browser saying "ey! it doesn't matter what happen, please connect to me always using HTTPS for the following 3153600 seconds".<br /><br />The hardest part in the HSTS feature is in the browser part. A browser needs to read this header and do all the necessary actions to ensure that it follows the policy. <a href="http://caniuse.com/#feat=stricttransportsecurity" target="_blank">Most browsers support HSTS</a> despite IE didn't support it until June 9th 2015. While I was delivering my talk in DEF CON (August 2015), an attendant from the first row correct me when I said "IE doesn't support HSTS". He was right about that, because I'm not an IE user and I tested it for the last time a few months before the talk. I asked him if this was something recent but he told me that "six months ago" (around February) which isn't exactly what I have found documentd. Anyway, It supports HSTS now.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-xBLMQhkh0bI/VjWste0piuI/AAAAAAAACDc/LjVQkDO5RkQ/s1600/caniuse.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="168" src="http://1.bp.blogspot.com/-xBLMQhkh0bI/VjWste0piuI/AAAAAAAACDc/LjVQkDO5RkQ/s400/caniuse.png" width="400" /></a></div><br />In addition, Google and Mozilla created a Preloaded HSTS list for their browsers (later the idea was used in other browsers). A preloaded list is a list of well-known providers (google, twitter, facebook, paypal, etc) where HSTS is "enforced by default". The goal of this preloaded list is to avoid the security gap when a user have just installed his browser or cleaned his cache, or when he visits a website for the first time, before any HSTS policy has ben set.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-hfBG2x6_2kY/VjWooSxp6YI/AAAAAAAACDI/S1eVVrFWnhk/s1600/preloaded.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="170" src="http://2.bp.blogspot.com/-hfBG2x6_2kY/VjWooSxp6YI/AAAAAAAACDI/S1eVVrFWnhk/s400/preloaded.png" width="400" /></a></div><br />Despite information from <a href="https://www.chromium.org/hsts" target="_blank">Google</a> or <a href="https://blog.mozilla.org/security/2012/11/01/preloading-hsts/" target="_blank">Mozilla</a> seem to talk about the HSTS preloaded list as a static list, the real truth is that preloaded entries are treated exactly the same than dynamic entries. When a browser is installed or its cache is cleaned, all entries in this list are added as dynamic entries using a default value (10 weeks) and they're updated in the same way than dynamic entries are so, in real life, it doesn't make a difference for a Delorean.&nbsp; <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-4qSovn-N1wI/VjWoxrpPcLI/AAAAAAAACDQ/ejN9gLUAMHA/s1600/chrome.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="245" src="http://1.bp.blogspot.com/-4qSovn-N1wI/VjWoxrpPcLI/AAAAAAAACDQ/ejN9gLUAMHA/s400/chrome.png" width="400" /></a></div><br />The only browser that I have found in my research which works in a different way is Apple Safari. It stores a .plist a preloaded list and it forces always HSTS in those hosts. It doesn't matter the local clock.<br /><br />Since we know that HSTS policy will avoid us from intercepting the first HTTP connection and, as a consequence, from using SSLStrip (or intercepting the communication in any other way), in the amount of seconds specified in the "max-age" parameter, our attack against HSTS is based on updating the local clock in order to make HSTS cache to expire. When there isn't any entry in the HSTS cache, a browser will work as usual, so when typing hostnames such as "mail.google.com" it will connect using HTTP before being redirected to HTTPS. <br /><br /><center><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/_uWxZvJeJhY" width="560"></iframe></center><br />My talk in BlackHat Europe last year was based in this attack, and it was published several months ago, so you can have a look if my accent doesn't hurt you (as a comment in youtube said) ;)<br /><br /><center><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/eLhb4jZuv6M" width="560"></iframe></center></div>